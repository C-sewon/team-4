#include "raylib.h"
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define TIME_LIMIT 7.0f
#define MAX_INPUT 10

int main(void)
{
    InitWindow(800, 450, "Math Game - Solve within 7 seconds!");
    SetTargetFPS(60);
    srand((unsigned)time(NULL));

    int num1 = rand() % 20 + 1;
    int num2 = rand() % 20 + 1;
    int answer = num1 + num2;
    char input[MAX_INPUT] = {0};
    int inputIndex = 0;
    float timer = TIME_LIMIT;
    bool gameOver = false;

    while (!WindowShouldClose())
    {
        if (!gameOver)
        {
            timer -= GetFrameTime();

            int key = GetCharPressed();
            while (key > 0)
            {
                if (key >= '0' && key <= '9' && inputIndex < MAX_INPUT - 1)
                {
                    input[inputIndex++] = (char)key;
                    input[inputIndex] = '\0';
                }
                key = GetCharPressed();
            }

           
            if (IsKeyPressed(KEY_BACKSPACE) && inputIndex > 0)
            {
                input[--inputIndex] = '\0';
            }

        
            if (IsKeyPressed(KEY_ENTER))
            {
                // if no input -> game over
                if (inputIndex == 0)
                {
                    gameOver = true;
                }
                else
                {
                    int userAnswer = atoi(input);
                    if (userAnswer == answer)
                    {
                       
                        num1 = rand() % 20 + 1;
                        num2 = rand() % 20 + 1;
                        answer = num1 + num2;
                        inputIndex = 0;
                        input[0] = '\0';
                        timer = TIME_LIMIT;
                    }
                    else
                    {
                        // wrong -> game over
                        gameOver = true;
                    }
                }
            }

           
            if (timer <= 0.0f)
            {
                gameOver = true;
            }
        }

        // ====== DRAW ======
        BeginDrawing();
        ClearBackground(RAYWHITE);

        if (!gameOver)
        {
            DrawText(TextFormat("%d + %d = ?", num1, num2), 300, 120, 48, DARKBLUE);
            DrawText(TextFormat("Your answer: %s", (inputIndex > 0) ? input : ""), 300, 200, 28, GRAY);
            DrawText(TextFormat("Time left: %.1f s", timer), 300, 260, 28, RED);
            DrawText("Press Enter to submit (empty or wrong -> GAME OVER).", 120, 340, 18, DARKGRAY);
        }
        else
        {
            DrawText("GAME OVER", 260, 170, 72, RED);
            DrawText(TextFormat("%d + %d = %d", num1, num2, answer), 300, 260, 28, DARKBLUE);
            DrawText("Press any key to exit.", 300, 320, 22, GRAY);

            // wait a short moment so user sees message, then allow exit by key
            EndDrawing();
            // small pause so text renders before close (raylib 제공 함수가 없으면 이 줄 제거 가능)
            // WaitTime(0.5); // (optional) uncomment if your raylib supports it

            // block until any key pressed or window closed
            while (!WindowShouldClose())
            {
                if (IsKeyPressed(KEY_ENTER) || IsKeyPressed(KEY_SPACE) || IsKeyPressed(KEY_ESCAPE) ||
                    GetKeyPressed() != 0 || GetCharPressed() != 0)
                {
                    break;
                }
                // draw the GAME OVER frame continuously to keep the window responsive
                BeginDrawing();
                ClearBackground(RAYWHITE);
                DrawText("GAME OVER", 260, 170, 72, RED);
                DrawText(TextFormat("%d + %d = %d", num1, num2, answer), 300, 260, 28, DARKBLUE);
                DrawText("Press any key to exit.", 300, 320, 22, GRAY);
                EndDrawing();
            }
            break;
        }

        
        EndDrawing();
    }

    CloseWindow();
    return 0;
}
